<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
</head>

<body>
    <button onclick="loadPhones()" id="button">Загрузить phones.json!</button>
    <div id="phones-list"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
    <script type="text/template" id="phones-template">
        <ul>
            <% _.forEach(phones, function(phone){ %>
                <li>
                    <%=phone.name%>
                </li>
                <% }); %>
        </ul>
    </script>

    <p></p>
    <button onclick="loadDigits()" id="button2">Загрузить digits!</button>
    <div id="digits-log"></div>
    <script>
    function loadPhones() {
        var xhr = new XMLHttpRequest();

        xhr.open('GET', 'phones.json', true); // true - async запрос

        xhr.onreadystatechange = function() {
            // xhr.status, xhr.statusText, xhr.responseText, xhr.responseXML.querySelector("...")
            if (xhr.readyState != 4) return;
            // Коды состояний:
            // const unsigned short UNSENT = 0; // начальное состояние
            // const unsigned short OPENED = 1; // вызван open
            // const unsigned short HEADERS_RECEIVED = 2; // получены заголовки
            // const unsigned short LOADING = 3; // загружается тело (получен очередной пакет данных)
            // const unsigned short DONE = 4; // запрос завершён

            button.innerHTML = 'Готово!';

            if (xhr.status != 200) { // обработать ошибку
                console.log(xhr.status + ': ' + xhr.statusText);
            } else { // вывести результат
                try {
                    var phones = JSON.parse(xhr.responseText);
                } catch (e) {
                    console.log('Invalid JSON received: ' + e.message);
                }
                document.getElementById('phones-list').innerHTML = render(phones);
            }

        }

        xhr.send(); // внутри send - тело запроса; для GET запроса - пустое

        button.innerHTML = 'Загружаю...';
        button.disabled = true;
    }


    function render(phones) { // returns rendered HTML
        var tmpl = _.template(document.getElementById('phones-template').innerHTML, {
            'variable': 'phones'
        });
        var res = tmpl(phones);

        return res;
    }
    </script>
    <script>
    function loadDigits() {
        var digitsLog = document.getElementById('digits-log');

        var xhr = new XMLHttpRequest();
        digitsLog.innerHTML += "xhr.readyState: " + xhr.readyState + "<br/>";

        xhr.open('GET', '/digits', true); // true - async запрос
        digitsLog.innerHTML += "xhr.readyState: " + xhr.readyState + "<br/>";

        xhr.onreadystatechange = function() {
            digitsLog.innerHTML += "xhr.readyState: " + xhr.readyState 
                                   + ". Получено символов xhr.responseText: " + xhr.responseText.length + "<br/>";
            if (xhr.readyState != 4) return;
            button2.innerHTML = 'Готово!';

            if (xhr.status != 200) { // обработать ошибку
                console.log(xhr.status + ': ' + xhr.statusText);
            }
        }

        xhr.send(); 

        button2.innerHTML = 'Загружаю...';
        button2.disabled = true;
    }
    </script>
</body>

</html>
